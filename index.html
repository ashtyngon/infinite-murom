<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>–°–ª–∞—Ç–∏—Å–ª–∞—Ç 3000: –õ–µ—Ç–æ–ø–∏—Å—å & –í—ã–±–æ—Ä</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet" />
  <style>
    :root{
      --primary-glow:#FF00FF;
      --secondary-glow:#00FFFF; /* ‚Üê —Ñ–∏–∫—Å: –±–µ–∑ —Ç–æ—á–∫–∏ */
      --text:#EAEAEA;
      --bg:#130a16;
      --panel:#211626;
      --bar-power:#ff4757;
      --bar-dipl:#3742fa;
      --bar-culture:#f1c40f;
      --bar-gold:#4cd137;
      --bar-bond:#ff9ff3;
      --ok:rgba(255,255,255,.1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Russo One',sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #2b1633 0%, transparent 60%),
                  radial-gradient(1200px 600px at 80% 100%, #18233a 0%, transparent 60%),
                  var(--bg);
      overflow:hidden;
      display:flex;justify-content:center;
    }
    .wrap{display:flex;flex-direction:column;height:100dvh;width:100%;max-width:640px}
    header{
      display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
      padding:10px;border-bottom:1px solid var(--primary-glow);background:#0f0a13aa;backdrop-filter:blur(4px)
    }
    .stat{ text-align:center }
    .stat .icon{font-size:1.2rem;text-shadow:0 0 8px var(--secondary-glow)}
    .bar-wrap{width:100%;height:8px;background:var(--ok);border:1px solid #ffffff22;border-radius:6px;margin-top:6px;overflow:hidden}
    .bar{height:100%;width:50%;transition:width .25s ease;box-shadow:0 0 10px}
    #sPower .bar{background:var(--bar-power);box-shadow:0 0 10px var(--bar-power)}
    #sDipl .bar{background:var(--bar-dipl);box-shadow:0 0 10px var(--bar-dipl)}
    #sCult .bar{background:var(--bar-culture);box-shadow:0 0 10px var(--bar-culture)}
    #sGold .bar{background:var(--bar-gold);box-shadow:0 0 10px var(--bar-gold)}
    #sBond .bar{background:var(--bar-bond);box-shadow:0 0 10px var(--bar-bond)}
    .log{flex:1;overflow-y:auto;scroll-behavior:smooth;padding:14px;display:flex;flex-direction:column-reverse}
    .entry{
      margin:10px 0;padding:14px;background:#231826d0;border:1px solid #ffffff1a;border-radius:12px;
      box-shadow:0 0 10px #ff00ff22;opacity:0;transform:translateY(16px);
      animation:fadeIn .4s ease forwards
    }
    @keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
    .who{color:var(--secondary-glow);margin-bottom:8px}
    .text{line-height:1.5}
    .decided{margin-top:8px;border-top:1px dashed #00ffff88;padding-top:6px;color:#00ffffc0;font-style:italic}
    footer{
      border-top:1px solid var(--primary-glow);padding:10px;background:#0f0a13cc;backdrop-filter:blur(4px)
    }
    .current{
      background:var(--panel);border:1px solid #ffffff1a;border-radius:12px;padding:12px;margin-bottom:10px
    }
    .audio{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .play{font-size:1.6rem;color:var(--primary-glow)}
    .pbar{flex:1;height:8px;background:var(--ok);border:1px solid var(--primary-glow);border-radius:6px;overflow:hidden}
    .pfill{height:100%;width:0;background:var(--primary-glow)}
    .pfill.play{animation:prog 1.8s linear forwards}
    @keyframes prog{from{width:0}to{width:100%}}
    .who-live{color:#00ffff99;margin-bottom:4px}
    .text-live{line-height:1.5}
    .choices{display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px}
    .btn{
      background:var(--panel);border:1px solid #00ffff99;color:#c9fcff;padding:14px;border-radius:10px;
      text-align:left;cursor:pointer;transition:transform .05s ease, box-shadow .15s ease
    }
    .btn:active{transform:scale(.99)}
    .btn:hover{box-shadow:0 0 14px #00ffff55}
    .row{display:flex;gap:8px}
    .half{flex:1}
    .hud{
      display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:.85rem;color:#ffffff80
    }
    .tog{display:flex;align-items:center;gap:6px}
    .modal{
      position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#000c;z-index:50;
      opacity:0;pointer-events:none;transition:opacity .25s ease
    }
    .modal.show{opacity:1;pointer-events:auto}
    .card{
      background:var(--panel);border:2px solid var(--primary-glow);border-radius:18px;max-width:92%;padding:22px;text-align:center;
      transform:scale(.9);transition:transform .25s ease
    }
    .modal.show .card{transform:scale(1)}
    .card h2{color:var(--primary-glow);margin-bottom:8px}
    .chip{display:inline-block;margin:6px 4px 0;padding:6px 10px;border-radius:999px;border:1px solid #ffffff22;background:#ffffff12;font-size:.85rem}
    .kbd{font-family:monospace;background:#00000040;padding:2px 6px;border-radius:6px;border:1px solid #ffffff22}
    .muted{opacity:.7}
    @media (min-width:520px){ .choices{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="stat" id="sPower"><div class="icon">üí™</div><div class="bar-wrap"><div class="bar"></div></div></div>
      <div class="stat" id="sDipl"><div class="icon">üé≠</div><div class="bar-wrap"><div class="bar"></div></div></div>
      <div class="stat" id="sCult"><div class="icon">üé®</div><div class="bar-wrap"><div class="bar"></div></div></div>
      <div class="stat" id="sGold"><div class="icon">üí∞</div><div class="bar-wrap"><div class="bar"></div></div></div>
      <div class="stat" id="sBond"><div class="icon" title="–°–≤—è–∑—å —Å –∫–æ–º–ø–∞–Ω—å–æ–Ω–æ–º">ü§ù</div><div class="bar-wrap"><div class="bar"></div></div></div>
    </header>

    <main id="log" class="log"></main>

    <footer>
      <div class="current">
        <div class="audio">
          <div class="play" aria-hidden="true">‚ñ∂</div>
          <div class="pbar"><div id="pfill" class="pfill"></div></div>
        </div>
        <div id="who" class="who-live"></div>
        <div id="text" class="text-live"></div>
        <div class="hud">
          <div class="tog"><input type="checkbox" id="cw" /><label for="cw" title="–°–º–µ–ª—ã–π —Ä–µ–∂–∏–º (–Ω–∞–º—ë–∫–∏, —Ñ–ª–∏—Ä—Ç, fade-to-black), –±–µ–∑ –ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ–∏–∏.">–°–º–µ–ª—ã–π —Ä–µ–∂–∏–º</label></div>
          <div class="muted">–°–≤–∞–π–ø—ã: <span class="kbd">‚Üê/‚Üí</span> –∏–ª–∏ –∫–∞—Å–∞–Ω–∏—è</div>
        </div>
      </div>
      <div id="choices" class="choices"></div>
      <div class="row">
        <button id="saveBtn" class="btn half">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="loadBtn" class="btn half">‚§¥ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </footer>
  </div>

  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <h2 id="mTitle">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
      <p id="mText" class="muted"></p>
      <div id="mChips"></div>
      <div style="margin-top:12px">
        <button id="restart" class="btn">üîÅ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <script>
    // ======= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï =======
    const vib = ms => { try{ if (navigator.vibrate) navigator.vibrate(ms) }catch{} };
    const clamp = (v,min=0,max=100)=>Math.max(min,Math.min(max,v));
    const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    // ======= –ò–ì–†–ê =======
    class Game {
      constructor(){
        // DOM
        this.ui = {
          bars:{
            power:document.querySelector('#sPower .bar'),
            diplomacy:document.querySelector('#sDipl .bar'),
            culture:document.querySelector('#sCult .bar'),
            gold:document.querySelector('#sGold .bar'),
            bond:document.querySelector('#sBond .bar'),
          },
          log:document.getElementById('log'),
          who:document.getElementById('who'),
          text:document.getElementById('text'),
          pfill:document.getElementById('pfill'),
          choices:document.getElementById('choices'),
          modal:document.getElementById('modal'),
          mTitle:document.getElementById('mTitle'),
          mText:document.getElementById('mText'),
          mChips:document.getElementById('mChips'),
          restart:document.getElementById('restart'),
          saveBtn:document.getElementById('saveBtn'),
          loadBtn:document.getElementById('loadBtn'),
          cw:document.getElementById('cw'),
        };
        this.story = this.defineStory();
        this.bind();
        this.start();
      }

      bind(){
        this.ui.restart.onclick=()=>this.start();
        this.ui.saveBtn.onclick=()=>this.save();
        this.ui.loadBtn.onclick=()=>this.load();
        // —Å–≤–∞–π–ø—ã
        let touchX=null;
        document.addEventListener('touchstart',e=>{ if(!e.touches?.length) return; touchX = e.touches[0].clientX },{passive:true});
        document.addEventListener('touchend',e=>{
          if(touchX===null) return;
          const dx=(e.changedTouches?.[0]?.clientX ?? touchX)-touchX;
          if (Math.abs(dx)>50) { dx>0?this.chooseIndex(1):this.chooseIndex(0) }
          touchX=null;
        },{passive:true});
        // –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown',e=>{
          if (e.key==='ArrowLeft') this.chooseIndex(0);
          if (e.key==='ArrowRight') this.chooseIndex(1);
          if (e.key==='Enter') this.chooseIndex(0);
        });
      }

      start(){
        this.hideModal();
        this.state = {
          power:50, diplomacy:50, culture:50, gold:50, bond:0,
          year:912, turns:0,
          flags:{ writing:false, companion:null, cw:this.ui.cw.checked },
          node:'start', seed:rand(1,9999)
        };
        this.ui.cw.onchange=()=>this.state.flags.cw=this.ui.cw.checked;
        this.ui.log.innerHTML='';
        this.paint();
        this.playNode();
      }

      paint(){
        const {power,diplomacy,culture,gold,bond} = this.state;
        this.ui.bars.power.style.width=power+'%';
        this.ui.bars.diplomacy.style.width=diplomacy+'%';
        this.ui.bars.culture.style.width=culture+'%';
        this.ui.bars.gold.style.width=gold+'%';
        this.ui.bars.bond.style.width=bond+'%';
      }

      defineStory(){
        // –£–∑–ª—ã: character, text(state), choices:[{text, effects, next, action}]
        return {
          start:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text: s=>`–ì–æ–¥ ${s.year}. –ó–µ–º–ª–∏ –ú—É—Ä–æ–º–∞ –∂–¥—É—Ç –ø—Ä–∞–≤–∏—Ç–µ–ª—è. –í–∞—Ä—è–≥ –•–µ–ª—å–≥–∏—Ä —Ö–ª–æ–ø–∞–µ—Ç —Ç–µ–±—è –ø–æ –ø–ª–µ—á—É.`,
            choices:[{text:'–°–ª—É—à–∞—Ç—å –±–∞—Ç—é...', next:'helgir'}]
          },
          helgir:{
            character:'–•–µ–ª—å–≥–∏—Ä',
            text: _=>`–°—ã–Ω, —Ç—É—Ç –ø—è—Ç—å –ø–ª–µ–º—ë–Ω –±–µ–∑ —Ç–æ–ª–∫—É —Å–ø–æ—Ä—è—Ç. –¢—ã –±—É–¥–µ—à—å –ª—å–¥–æ–º –∏–ª–∏ –ø–ª–∞–º–µ–Ω–µ–º?`,
            choices:[
              {text:'–°–∏–ª–∞ –∏ —è—Ä–æ—Å—Ç—å.', effects:{power:+15,diplomacy:-10}, next:'war1'},
              {text:'–•–∏—Ç—Ä–æ—Å—Ç—å –∏ —Å–æ—é–∑—ã.', effects:{diplomacy:+15,gold:-10}, next:'dip1'}
            ]
          },
          war1:{
            character:'–í–æ–µ–≤–æ–¥–∞ –Ø—Ä–æ–º–∏—Ä',
            text:_=>'–î—Ä—É–∂–∏–Ω–∞ –∂–¥—ë—Ç. –ë—å—ë–º –±–æ–≥–∞—á–µ –ú–µ—â–µ—Ä—É –∏–ª–∏ —Å–ª–∞–±–µ–µ –†–∞–¥–∏–º–∏—á–µ–π?',
            choices:[
              {text:'–ú–µ—â–µ—Ä–∞ (–¥–æ–±—ã—á–∞).', effects:{power:+8,gold:+15,diplomacy:-10}, next:'feastHook'},
              {text:'–†–∞–¥–∏–º–∏—á–∏ (–±—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞).', effects:{power:+12,diplomacy:-6}, next:'feastHook'}
            ]
          },
          dip1:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text:_=>'–ü–æ—Å–ª—ã —Ä–∞–∑–æ—Å–ª–∞–Ω—ã. –°—Ç–∞—Ä–µ–π—à–∏–Ω—ã –ú—É—Ä–æ–º–∞ –∑–æ–≤—É—Ç –Ω–∞ –ø–∏—Ä –∏ —Ç–æ—Ä–≥.',
            choices:[
              {text:'–ò–¥—ë–º –Ω–∞ –ø–∏—Ä –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏.', effects:{diplomacy:+8}, next:'feastHook'},
              {text:'–ü–æ—Ç–æ—Ä–≥—É–µ–º—Å—è –∂—ë—Å—Ç—á–µ.', effects:{power:+5,diplomacy:-5,gold:+5}, next:'feastHook'}
            ]
          },
          feastHook:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text:_=>'–ù–∞ –ø–∏—Ä—É —Ç—ã –ª–æ–≤–∏—à—å –≤–∑–≥–ª—è–¥ –±–∞–Ω—â–∏–∫–∞ ‚Äî –†–∞–¥–æ–≥–æ—Å—Ç. –ê —É –æ—á–∞–≥–∞ —à–ª–∏—Ñ—É–µ—Ç —Å–µ–∫–∏—Ä—É –Ø—Ä–æ–º–∏—Ä.',
            choices:[
              {text:'–ü–æ–¥–æ–π—Ç–∏ –∫ –†–∞–¥–æ–≥–æ—Å—Ç—É.', next:'r1'},
              {text:'–ü–µ—Ä–µ–∫–∏–Ω—É—Ç—å—Å—è —Å–ª–æ–≤–æ–º —Å –Ø—Ä–æ–º–∏—Ä–æ–º.', next:'y1'}
            ]
          },
          // === –†–∞–¥–æ–≥–æ—Å—Ç: —É—á—ë–Ω—ã–π/—Ç—ë–ø–ª—ã–π M/M –º–∞—Ä—à—Ä—É—Ç (—Ä–æ–º–∞–Ω—Ç–∏–∫–∞ PG-13) ===
          r1:{
            character:'–†–∞–¥–æ–≥–æ—Å—Ç',
            text:s=> s.flags.cw
              ? '–ö–Ω—è–∑—å‚Ä¶ –≤—ã —Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–∞–∫, —á—Ç–æ —É –º–µ–Ω—è –∂–∞—Ä –≤ –≥—Ä—É–¥–∏. –£ –º–µ–Ω—è –µ—Å—Ç—å –º—ã—Å–ª—å: –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ—á—å –Ω–∞ –±–µ—Ä–µ—Å—Ç–µ.'
              : '–ö–Ω—è–∑—å, —É –º–µ–Ω—è –º—ã—Å–ª—å: –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ—á—å –Ω–∞ –±–µ—Ä–µ—Å—Ç–µ. –≠—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.',
            choices:[
              {text:'¬´–ü–æ–∫–∞–∂–∏. –ò‚Ä¶ –æ—Å—Ç–∞–≤–∞–π—Å—è —Ä—è–¥–æ–º.¬ª', effects:{culture:+14,gold:-8}, action: s=>{s.flags.writing=true; s.flags.companion='–†–∞–¥–æ–≥–æ—Å—Ç'; s.bond=(s.bond+12)}, next:'r2'},
              {text:'¬´–≠—Ç–æ –¥–ª—è –ø–∏—Å—Ü–æ–≤. –°–µ–π—á–∞—Å –Ω–µ –¥–æ —Ç–æ–≥–æ.¬ª', effects:{culture:-8}, next:'eco1'}
            ]
          },
          r2:{
            character:'–†–∞–¥–æ–≥–æ—Å—Ç',
            text:s=> s.flags.cw
              ? '–ù–æ—á—å —Ç–µ–ø–ª–∞. –û–Ω –∫–∞—Å–∞–µ—Ç—Å—è —Ç–≤–æ–µ–π —Ä—É–∫–∏; —à—ë–ø–æ—Ç –∫–æ—Ä–æ—á–µ –¥—ã—Ö–∞–Ω–∏—è. –î–∞–ª–µ–µ ‚Äî —Ç—å–º–∞ –∑–∞ –æ–∫–Ω–æ–º. (fade to black)'
              : '–í—ã –±–µ—Å–µ–¥—É–µ—Ç–µ –¥–æ–ø–æ–∑–¥–Ω–∞. –¢–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è –æ–±—Ä–µ—Ç–∞—é—Ç —á—ë—Ç–∫–∏–µ –∑–∞–ø–∏—Å–∏.',
            choices:[
              {text:'–ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ.', effects:{bond:+10,culture:+6}, next:'eco1'},
              {text:'–î–µ—Ä–∂–∞—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é.', effects:{bond:-6}, next:'eco1'}
            ]
          },

          // === –Ø—Ä–æ–º–∏—Ä: –≤–æ–∏–Ω/–æ—Å—Ç—Ä—ã–π M/M –º–∞—Ä—à—Ä—É—Ç (—Ä–æ–º–∞–Ω—Ç–∏–∫–∞ PG-13) ===
          y1:{
            character:'–Ø—Ä–æ–º–∏—Ä',
            text:s=> s.flags.cw
              ? '–ö–Ω—è–∑—å. –ì–ª—è–∂—É, –∏—Å–∫—Ä–∞ –≤ –≥–ª–∞–∑–∞—Ö. –ò –≤ –±–∏—Ç–≤–µ, –∏ —É –æ—á–∞–≥–∞ —è –≤–µ—Ä–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∏–º –≤–µ—Ä–Ω–æ—Å—Ç—å?'
              : '–ö–Ω—è–∑—å. –í –±–∏—Ç–≤–µ —è —Ä—è–¥–æ–º. –ü–ª–∞–Ω–∏—Ä—É–π ‚Äî —è –∏—Å–ø–æ–ª–Ω—é.',
            choices:[
              {text:'¬´–ü—Ä–æ–≤–µ—Ä–∏–º‚Ä¶ –≤ –¥–æ–∑–æ—Ä–µ.¬ª', effects:{power:+10,bond:+8}, action:s=>s.flags.companion='–Ø—Ä–æ–º–∏—Ä', next:'y2'},
              {text:'¬´–°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞.¬ª', effects:{diplomacy:+6}, next:'eco1'}
            ]
          },
          y2:{
            character:'–Ø—Ä–æ–º–∏—Ä',
            text:s=> s.flags.cw
              ? '–ù–æ—á–Ω–∞—è —Å—Ç—Ä–∞–∂–∞ –¥–ª–∏–Ω–Ω–∞. –ü–ª–µ—á–æ –∫ –ø–ª–µ—á—É ‚Äî –¥—ã—Ö–∞–Ω–∏–µ —Å–ª—ã—à–Ω–æ. –°–ª–æ–≤–∞ –∫–æ—Ä–æ—á–µ, —á–µ–º –ø–∞—É–∑—ã. (fade to black)'
              : '–í—ã –æ–±—Å—É–∂–¥–∞–µ—Ç–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ —Å–∏–≥–Ω–∞–ª—ã.',
            choices:[
              {text:'–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ—é–∑.', effects:{bond:+8,power:+6}, next:'eco1'},
              {text:'–î–µ—Ä–∂–∞—Ç—å —Å—É–±–æ—Ä–¥–∏–Ω–∞—Ü–∏—é.', effects:{bond:-5}, next:'eco1'}
            ]
          },

          // === –≠–∫–æ–Ω–æ–º–∏–∫–∞ / —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ===
          eco1:{
            character:'–ö–∞–∑–Ω–∞—á–µ–π',
            text:_=>'–ö–∞–∑–Ω–∞ —Ç–æ–Ω–∫–∞. ¬´–û–∫—Å–∫–∏–π —Å–±–æ—Ä¬ª —Å–ø–∞—Å—ë—Ç, –Ω–æ –±—É–¥–µ—Ç —Ä–æ–ø–æ—Ç.',
            choices:[
              {text:'–í–≤–µ—Å—Ç–∏ –º—è–≥–∫–æ (–ª—å–≥–æ—Ç—ã —Ä–µ–º–µ—Å–ª—É).', effects:{gold:+14,diplomacy:-6,culture:+4}, next:'midEvent'},
              {text:'–û—Ç–ª–æ–∂–∏—Ç—å. –°–¥–µ–ª–∞—Ç—å —è—Ä–º–∞—Ä–∫—É.', effects:{gold:-8,culture:+10,diplomacy:+6}, next:'midEvent'}
            ]
          },

          // === –°–µ—Ä–µ–¥–∏–Ω–Ω—ã–µ —Ä–∞–Ω–¥–æ–º-—Å–æ–±—ã—Ç–∏—è, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç –∫–æ–º–ø–∞–Ω—å–æ–Ω–∞ ===
          midEvent:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text:s=>{
              if (s.flags.companion==='–†–∞–¥–æ–≥–æ—Å—Ç') return '–†–∞–¥–æ–≥–æ—Å—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ë–µ—Ä–µ—Å—Ç—è–Ω–æ–π –£—Å—Ç–∞–≤: —Å—É–¥ –ø–æ –∑–∞–ø–∏—Å—è–º, –º–µ–Ω—å—à–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.';
              if (s.flags.companion==='–Ø—Ä–æ–º–∏—Ä') return '–Ø—Ä–æ–º–∏—Ä –ø—Ä–æ—Å–∏—Ç –∑–∞–∫—É–ø–∏—Ç—å –∫–æ–ª—å—á—É–≥–∏ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–∞—Å–µ—á–Ω—ã–µ –ª–∏–Ω–∏–∏.';
              return '–°–æ–≤–µ—Ç –≤ —Ä–∞–∑–ª–∞–¥–µ: —á–µ–≥–æ –±–æ–ª—å—à–µ ‚Äî –∑–∞–∫–æ–Ω–∞ –∏–ª–∏ –º–µ—á–∞?';
            },
            choices:s=>{
              if (s.flags.companion==='–†–∞–¥–æ–≥–æ—Å—Ç') return [
                {text:'–ü—Ä–∏–Ω—è—Ç—å –£—Å—Ç–∞–≤.', effects:{culture:+10,diplomacy:+6,gold:-6,bond:+6}, next:'crisis'},
                {text:'–û—Ç–ª–æ–∂–∏—Ç—å —Ä–µ—Ñ–æ—Ä–º—ã.', effects:{diplomacy:-6}, next:'crisis'}
              ];
              if (s.flags.companion==='–Ø—Ä–æ–º–∏—Ä') return [
                {text:'–í–ª–∏—Ç—å –∑–æ–ª–æ—Ç–æ –≤ –¥—Ä—É–∂–∏–Ω—É.', effects:{power:+12,gold:-10,bond:+6}, next:'crisis'},
                {text:'–°–¥–µ—Ä–∂–∞—Ç—å –∞–ø–ø–µ—Ç–∏—Ç—ã.', effects:{diplomacy:+6,power:-6}, next:'crisis'}
              ];
              return [
                {text:'–ë–∞–ª–∞–Ω—Å –º–µ—á–∞ –∏ –∑–∞–∫–æ–Ω–∞.', effects:{power:+6,culture:+6}, next:'crisis'},
                {text:'–í–æ–ª—é–Ω—Ç–∞—Ä–∏–∑–º –∫–Ω—è–∑—è.', effects:{diplomacy:-8,power:+4}, next:'crisis'}
              ];
            }
          },

          // === –ö—Ä–∏–∑–∏—Å: –≤–Ω–µ—à–Ω—è—è —É–≥—Ä–æ–∑–∞ ===
          crisis:{
            character:'–î–æ–∑–æ—Ä–Ω—ã–π',
            text:_=>'–°–ª—É—Ö –æ –ø–æ—Ö–æ–¥–µ –ø–µ—á–µ–Ω–µ–≥–æ–≤. –ß—Ç–æ –¥–µ–ª–∞–µ–º?',
            choices:[
              {text:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã —Å –¥–∞—Ä–∞–º–∏.', effects:{diplomacy:+10,gold:-10}, next:'preEnd'},
              {text:'–ó–∞—Å–∞–¥—ã —É –±—Ä–æ–¥–∞.', effects:{power:+10}, next:'preEnd'}
            ]
          },

          preEnd:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text:s=>{
              s.year += rand(1,3);
              // –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π ¬´–∏–∑–Ω–æ—Å¬ª
              s.power = clamp(s.power- rand(0,3));
              s.gold  = clamp(s.gold - rand(0,3));
              s.culture = clamp(s.culture - rand(0,2));
              s.turns++;
              return `–ì–æ–¥ ${s.year}. –ò—Ç–æ–≥–∏ –±–ª–∏–∂–µ. –°–≤—è–∑–∏ —Ä–µ—à–∞—é—Ç —Å—É–¥—å–±—ã.`;
            },
            choices:[
              {text:'–ö —Ñ–∏–Ω–∞–ª—É.', next:'ending'}
            ]
          },

          // === –ö–æ–Ω—Ü–æ–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç–∞–º –∏ —Å–≤—è–∑—è–º ===
          ending:{
            character:'–õ–µ—Ç–æ–ø–∏—Å–µ—Ü',
            text:_=>'–õ–µ—Ç–æ–ø–∏—Å—å –∑–∞–∫—Ä—ã—Ç–∞. –°—É–¥ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏–±—ã–ª.',
            end: s=>{
              const tags=[];
              const lines=[];
              if (s.flags.companion==='–†–∞–¥–æ–≥–æ—Å—Ç' && s.bond>=60) {
                lines.push('¬´–í–µ–∫ –ü–µ—Ä–≥–∞–º–µ–Ω—Ç–∞¬ª: —Å –†–∞–¥–æ–≥–æ—Å—Ç–æ–º –≤—ã –∑–∞–∫—Ä–µ–ø–∏–ª–∏ –ø—Ä–∞–≤–æ –∏ –ø–∞–º—è—Ç—å. –í–∞—à–∏ –≤–∑–≥–ª—è–¥—ã ‚Äî —Ç–∞–π–Ω–∞ –∑–∞ —Å—Ç–∞–≤–Ω—è–º–∏, –Ω–æ –≥–æ—Ä–æ–¥ —à–µ–ø—á–µ—Ç —Å —Ç–µ–ø–ª–æ–º.');
                tags.push('üìú –†–∞–¥–æ–≥–æ—Å—Ç: –°–µ—Ä–¥–µ—á–Ω—ã–π —Å–æ—é–∑');
              }
              if (s.flags.companion==='–Ø—Ä–æ–º–∏—Ä' && s.bond>=60) {
                lines.push('¬´–©–∏—Ç –∏ –ü–ª–∞–º—è¬ª: –Ø—Ä–æ–º–∏—Ä —Å—Ç–∞–ª —Ç–≤—ë—Ä–¥–æ–π —Å—Ç–µ–Ω–æ–π, –∞ —Ç—ã ‚Äî –µ–≥–æ —Ç—ã–ª–æ–º. –í –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –±–∞–π–∫–∞—Ö –≤–∞—à–∏ –¥–æ–∑–æ—Ä—ã ‚Äî –æ—Å–æ–±–∞—è –≥–ª–∞–≤–∞.');
                tags.push('üõ°Ô∏è –Ø—Ä–æ–º–∏—Ä: –í–µ—Ä–Ω—ã–π —Å–æ—é–∑');
              }
              if (!lines.length) {
                lines.push('–¢—ã —É–¥–µ—Ä–∂–∞–ª –≤–ª–∞—Å—Ç—å, –Ω–æ —Å–µ—Ä–¥—Ü–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫–∞—Ö. –õ–µ—Ç–æ–ø–∏—Å—å –Ω–∞–º–µ–∫–∞–µ—Ç, –Ω–µ –∫—Ä–∏—á–∏—Ç.');
                tags.push('üåë –û–¥–∏–Ω–æ—á–Ω—ã–π –ø—É—Ç—å');
              }
              // —Å—Ç–∞—Ç—ã
              if (s.power>=70) tags.push('‚öî –°–∏–ª—å–Ω–∞—è –¥—Ä—É–∂–∏–Ω–∞');
              if (s.diplomacy>=70) tags.push('ü§ù –ú–∞—Å—Ç–µ—Ä —Å–æ—é–∑–æ–≤');
              if (s.culture>=70) tags.push('üé® –ü–æ–∫—Ä–æ–≤–∏—Ç–µ–ª—å —Ä–µ–º—ë—Å–µ–ª');
              if (s.gold>=70) tags.push('üí∞ –ü–æ–ª–Ω–∞—è –∫–∞–∑–Ω–∞');
              return { title:'–§–∏–Ω–∞–ª –õ–µ—Ç–æ–ø–∏—Å–∏', message:lines.join(' '), chips:tags };
            }
          }
        }
      }

      playNode(){
        const node = this.story[this.state.node];
        if (!node) return;
        // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä ¬´–∞—É–¥–∏–æ¬ª
        this.ui.pfill.classList.remove('play'); void this.ui.pfill.offsetWidth; this.ui.pfill.classList.add('play');

        // –¢–µ–∫—Å—Ç
        const text = (typeof node.text==='function') ? node.text(this.state) : node.text;
        this.ui.who.textContent = node.character;
        this.ui.text.textContent = text;

        // –ü–æ–∫–∞–∑ –≤—ã–±–æ—Ä–∞ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
        this.ui.choices.innerHTML='';
        setTimeout(()=>{
          if (node.end){
            const res = node.end(this.state);
            this.endGame(res.title, res.message, res.chips||[]);
          } else {
            const choices = (typeof node.choices==='function') ? node.choices(this.state) : node.choices;
            choices.forEach((ch, i)=>{
              const b=document.createElement('button');
              b.className='btn';
              b.innerText='‚Ä∫ '+ch.text;
              b.onclick=()=>this.pick(ch);
              this.ui.choices.appendChild(b);
              if (i===0) this._firstBtn=b;
              if (i===1) this._secondBtn=b;
            });
          }
        }, 900);
      }

      pick(choice){
        vib(10);
        const last = this.story[this.state.node];
        // –ª–æ–≥
        this.pushLog(last.character, (typeof last.text==='function')?last.text(this.state):last.text, choice.text);

        // —ç—Ñ—Ñ–µ–∫—Ç—ã
        if (choice.effects){
          for (const [k,v] of Object.entries(choice.effects)){
            this.state[k] = clamp(this.state[k]+v);
          }
        }
        if (typeof choice.action==='function') choice.action(this.state);
        this.paint();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–æ–≤
        if (this.failCheck()) return;

        // –ü–µ—Ä–µ—Ö–æ–¥
        this.state.node = choice.next;
        this.playNode();
      }

      chooseIndex(idx){
        const btns=[...this.ui.choices.querySelectorAll('.btn')];
        if (!btns.length) return;
        if (idx===0 && btns[0]) btns[0].click();
        if (idx===1 && btns[1]) btns[1].click();
      }

      pushLog(who,text,decision){
        const e=document.createElement('div');
        e.className='entry';
        e.innerHTML = `<div class="who">${who}</div>
                       <div class="text">${text}</div>
                       <div class="decided">–í—ã —Ä–µ—à–∏–ª–∏: ${decision}</div>`;
        this.ui.log.prepend(e);
      }

      failCheck(){
        const s=this.state;
        const fail = (title,msg)=>{
          this.endGame(title, `${msg} –í—ã –ø—Ä–∞–≤–∏–ª–∏ ${s.turns} –ª–µ—Ç.`, ['‚ùå –†–∞–Ω–Ω–∏–π —Ñ–∏–Ω–∞–ª']);
          return true;
        };
        if (s.power<=0) return fail('‚ò† –ü–æ—Ä–∞–∂–µ–Ω–∏–µ', '–î—Ä—É–∂–∏–Ω–∞ —Ä–∞–∑–±–µ–∂–∞–ª–∞—Å—å, –≤—Ä–∞–≥–∞–º –æ—Ç–∫—Ä—ã—Ç –ø—É—Ç—å.');
        if (s.diplomacy<=0) return fail('üíî –ò–∑–≥–Ω–∞–Ω–∏–µ', '–ë–æ—è—Ä–µ –∏ –Ω–∞—Ä–æ–¥ –æ—Ç–≤–µ—Ä–Ω—É–ª–∏—Å—å.');
        if (s.culture<=0) return fail('üóø –ó–∞–±–≤–µ–Ω–∏–µ', '–û —Ç–µ–±–µ –Ω–µ —Ö–æ—Ç—è—Ç –ø–æ–º–Ω–∏—Ç—å.');
        if (s.gold<=0) return fail('üìâ –ë–∞–Ω–∫—Ä–æ—Ç', '–ö–∞–∑–Ω–∞ –ø—É—Å—Ç–∞—è, –≤–ª–∞—Å—Ç—å —Ç–∞–µ—Ç.');
        return false;
      }

      endGame(title,message,chips=[]){
        this.ui.mTitle.textContent=title;
        this.ui.mText.textContent=message;
        this.ui.mChips.innerHTML = chips.map(t=>`<span class="chip">${t}</span>`).join('') || `<span class="chip">–ò—Ç–æ–≥ –∑–∞–ø–∏—Å–∞–Ω</span>`;
        this.showModal();
      }

      showModal(){ this.ui.modal.classList.add('show') }
      hideModal(){ this.ui.modal.classList.remove('show') }

      save(){
        const data = JSON.stringify(this.state);
        localStorage.setItem('slatislat3000', data);
        vib(6);
        this.toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      }
      load(){
        const data = localStorage.getItem('slatislat3000');
        if (!data) return this.toast('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π');
        try{
          this.state = JSON.parse(data);
          this.ui.cw.checked = !!this.state.flags?.cw;
          this.paint();
          this.playNode();
          vib(6);
          this.toast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ');
        }catch{ this.toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏') }
      }
      toast(msg){
        // –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–æ—Å—Ç ‚Äî —á–∏–ø –ø–æ–¥ –º–æ–¥–∞–ª–∫–æ–π
        const d=document.createElement('div');
        d.className='chip'; d.textContent=msg;
        d.style.position='fixed'; d.style.bottom='12px'; d.style.left='50%'; d.style.transform='translateX(-50%)';
        d.style.zIndex='60';
        document.body.appendChild(d);
        setTimeout(()=>d.remove(),1200);
      }
    }

    // ======= –ò–ù–ò–¶ =======
    window.addEventListener('load',()=>{ new Game() });
  </script>
</body>
</html>
